<?php

/**
 * @file
 * Module file. Gives the the users the ability to search for libraries
 */

/**
 * Implements hook_form_FORM_ID_alter
 * Creates a field for adding a URL for the Ting Agency Serach webservice
 */
function bibdk_vejviser_form_ting_admin_ting_settings_alter(&$form, &$form_state, $form_id) {
  $form['ting']['agency_search_url'] = array(
    '#type' => 'textfield',
    '#title' => t('OpenAgency URL'),
    '#description' => t('URL to the Ting agency search webservice, e.g. http://openagency.addi.dk/1.6/'),
    '#required' => TRUE,
    '#default_value' => variable_get('agency_search_url', ''),
  );
}

/**
 * Implements hook_block_info();
 */
function bibdk_vejviser_block_info() {
  $blocks['bibdk_vejviser'] = array(
    'info' => t('Bibdk Vejviser'),
    'description' => t('Search for libraries'),
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

/**
 * Implements hook_block_configure();
 */
function bibdk_vejviser_block_view($delta = '') {
  switch ($delta) {
    case 'bibdk_vejviser':
      $block['title'] = t('Find Library');
      $block['content'] = drupal_get_form('bibdk_vejviser_form');
      return $block;
      break;
  }
}


/**
 * Create the form array
 * @return type 
 */
function bibdk_vejviser_form() {
  $form = array();
  $form['name'] = array(
    '#type' => 'textfield',
    '#title' => t('Name'),
    '#size' => 5,
  );
  $form['zip'] = array(
    '#type' => 'textfield',
    '#title' => t('Zip'),
    '#size' => 5,
  );
  $form['city'] = array(
    '#type' => 'textfield',
    '#title' => t('City'),
    '#size' => 5,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Search'),
    '#executes_submit_callback' => TRUE,
  );
  return $form;
}

/**
 * Validate the the form input
 * @param type $form
 * @param type $form_state 
 */
function bibdk_vejviser_form_validate(&$form, &$form_state) {
  $name = $form_state['values']['name'];
  $zip = $form_state['values']['zip'];
  $city = $form_state['values']['city'];
  
  if( !bibdk_vejviser_validate_name($name) && !bibdk_vejviser_validate_zip($zip) && !bibdk_vejviser_validate_city($city)) {
    drupal_set_message(t('You haven\'t entered any search criteria.'), 'error');
  } else {
    module_load_include('inc', 'ting_openformat','ting_openformat.search_client');
    $client = new ting_client_class();
    $result = $client->do_agency_search(array('agencyName' => $name, 'postalCode' => $zip, 'city' => $city));
    
    dpm($result);
  }
}

/**
 * Validate the name form variable. Method might be unused if only one searchfield is used
 * @param type $name
 * @return boolean 
 */
function bibdk_vejviser_validate_name($name) {
  if (empty($name)) {
    return FALSE;
  }
  return TRUE;
}

/**
 * Validate the zip form variable. Method might be unused if only one searchfield is used
 * @param type $name
 * @return boolean 
 */
function bibdk_vejviser_validate_zip($zip) {
  if (empty($zip)) {
    return FALSE;
  }
  return TRUE;
}

/**
 * Validate the city form variable. Method might be unused if only one searchfield is used
 * @param type $name
 * @return boolean 
 */
function bibdk_vejviser_validate_city($city) {
  if (empty($city)) {
    return FALSE;
  }
  return TRUE;
}